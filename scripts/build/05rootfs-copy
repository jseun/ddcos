#!/bin/bash

DESC="Copying root filesystem"

source ${SHDIR}/functions

log_begin_msg "${DESC}"

{
  DIRS=($(find / -type d -print 2>/dev/null | \
    egrep -v "^(/proc|/dev|/sys|/tmp|/boot|/data)" | \
    egrep -v "^(/usr/share/man|/usr/share/locale)" | \
    egrep -v "^/var/lib/apt/lists/" | sort))
  n=${#DIRS[*]}; i=0
  [ -d $ROOTFS ] || mkdir -p $ROOTFS
  for dir in "${DIRS[@]:1}"; do
    destdir=${ROOTFS}${dir}
    PCT=$(( 99*(++i)/n ))
cat <<EOF
XXX
$PCT
Copying directory ${dir}...
XXX
EOF
    [ -d $destdir ] || mkdir $destdir
    cp -d ${dir}/* $destdir 2>/dev/null
  done
  (cd $ROOTFS; mkdir proc dev sys tmp boot)
  cp -ax /tmp/scripts ${ROOTFS}/tmp
} | whiptail --title "${DESC}" \
  --gauge "Calculating..." $LINES $COLUMNS 0

log_end_msg "done"
