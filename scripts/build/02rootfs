#!/bin/bash

DESC="Copying root filesystem"

source /scripts/functions

log_begin_msg "${DESC}"
[ -d ${ROOTFS}/bin ] && log_end_msg "cached"

{
  DIRS=($(find / -type d -print 2>/dev/null | \
    egrep -v "^(/proc|/dev|/sys|/tmp|/boot|/scripts|/data|/bundle)" | \
    egrep -v "^(/usr/share/man|/usr/share/locale|/usr/share/zoneinfo)" | sort))
  n=${#DIRS[*]}; i=0
  [ -d $ROOTFS ] || mkdir -p $ROOTFS
  for dir in "${DIRS[@]:1}"; do
    destdir=${ROOTFS}${dir}
    PCT=$(( 99*(++i)/n ))
cat <<EOF
XXX
$PCT
Copying directory ${dir}...
XXX
EOF
    [ -d $destdir ] || mkdir $destdir
    cp -d ${dir}/* $destdir 2>/dev/null
  done
  (cd $ROOTFS; mkdir proc dev sys tmp boot)
} | whiptail --title "${DESC}" \
  --gauge "Calculating..." 10 78 0

log_end_msg "done"
