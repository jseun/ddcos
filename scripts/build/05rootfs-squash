#!/bin/bash

DESC="Squashing root filesystem"

source ${SHDIR}/functions

log_begin_msg "${DESC}"
[ -e ${ROOTFS_SQUASH_FILE} ] && log_end_msg "cached"

apt-get install -qqy squashfs-tools

{
  DIRS=(${ROOTFS}/*/)
  n=${#DIRS[*]}; i=0
  for dir in "${DIRS[@]}"; do
    PCT=$(( 100*(++i)/n ))
cat <<EOF
XXX
$PCT
Processing ${dir}...
XXX
EOF
    mksquashfs ${dir} ${ROOTFS_SQUASH_FILE} >/dev/null 2>&1
  done
} | whiptail --title "${DESC}" \
  --gauge "Calculating..." $LINES $COLUMNS 0

log_end_msg "done"
