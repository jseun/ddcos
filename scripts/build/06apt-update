#!/bin/bash

DESC="Update APT repositories"


is_cached()
{
  return 1
}

source ${SHDIR}/functions

log_begin_msg "$DESC"
is_cached && log_end_msg "cached"

apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys \
    36A1D7869245C8950F966E92D8576A8BA88D21E9 >/dev/null 2>&1 && \
printf 'deb http://get.docker.io/ubuntu/ docker main\n' > \
    /etc/apt/sources.list.d/docker.list && \

sed -i '1ideb [trusted=yes] file:/lib/live/mount/medium/archives local main' \
  /etc/apt/sources.list
mkdir -p /lib/live/mount/medium
ln -sf ${APTDIR} /lib/live/mount/medium/archives

cat <<EOF > /etc/apt/preferences
Package: *
Pin: release n=local
Pin-Priority: 700

Package: lxc-docker
Pin: release n=docker
Pin-Priority: 500

Package: *
Pin: release o=Debian
Pin-Priority: 300
EOF

cat <<EOF > ${PKGDIR}/Release
Archive: testing
Origin: local
Component: main
Architecture: amd64
EOF

cat <<EOF > ${APTDIR}/dists/local/Release
Archive: testing
Codename: local
Components: main
Origin: local
Architectures: amd64
EOF

apt-get update >/dev/null 2>&1
log_end_msg "done"
