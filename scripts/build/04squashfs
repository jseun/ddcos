#!/bin/bash

DESC="Squashing root filesystem"
ROOTFS=/tmp/rootfs
OUTFILE=/tmp/iso/live/filesystem.squashfs

source /tmp/scripts/functions
log_begin_msg "${DESC}"

{
  DIRS=(${ROOTFS}/*/)
  n=${#DIRS[*]}; i=0
  outdir=$(dirname $OUTFILE)
  [ -d $outdir ] || mkdir -p $outdir
  for dir in "${DIRS[@]}"; do
    PCT=$(( 100*(++i)/n ))
cat <<EOF
XXX
$PCT
Processing ${dir}...
XXX
EOF
    mksquashfs ${dir} ${OUTFILE} >/dev/null 2>&1
  done
} | whiptail --title "${DESC}" \
  --gauge "Calculating..." 10 78 0

log_end_msg
